
# Servidor principal para dumontcloud.com e www.dumontcloud.com
server {
    server_name dumontcloud.com www.dumontcloud.com;

    # Marketing Live Docs
    location /admin/doc/live {
        proxy_pass http://127.0.0.1:8081/admin/doc/live;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/content/ {
        proxy_pass http://127.0.0.1:8081/api/content/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # VS Code Server - Demo com Machine Switcher
    location /demo/vscode/ {
        proxy_pass http://127.0.0.1:8767/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Accept-Encoding "";

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;

        # Permitir buffering para sub_filter funcionar
        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;

        # Injetar script no HTML
        sub_filter '</head>' '<script>window.DUMONT_API_URL="https://dumontcloud.com";window.DUMONT_MACHINE_ID="";</script><script src="./_static/src/browser/media/machine-switcher.js"></script></head>';
        sub_filter_once on;
        sub_filter_types text/html;

        rewrite ^/demo/vscode/?(.*)$ /$1 break;
    }

    # VS Code Server - Admin interface
    location /admin/vscode/ {
        proxy_pass http://127.0.0.1:8767/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
        proxy_buffering off;
        proxy_cache off;
        
        rewrite ^/admin/vscode/?(.*)$ /$1 break;
    }

    location / {
        proxy_pass http://127.0.0.1:8766/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        proxy_read_timeout 300;
        proxy_send_timeout 300;
        proxy_connect_timeout 60;
    }

    listen 443 ssl;
    listen [::]:443 ssl;
    ssl_certificate /etc/letsencrypt/live/dumontcloud.com-0001/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dumontcloud.com-0001/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# PROXY DIRETO para instance 28864630 porta 8080 (code-server)
server {
    server_name 28864630-8080.dumontcloud.com;

    location / {
        proxy_pass http://79.112.1.66:34877;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
        proxy_buffering off;
        proxy_cache off;
    }

    listen 443 ssl;
    listen [::]:443 ssl;
    ssl_certificate /etc/letsencrypt/live/dumontcloud.com-0001/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dumontcloud.com-0001/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# PROXY DIRETO para instance 28864630 porta 6006 (TensorBoard)
server {
    server_name 28864630-6006.dumontcloud.com;

    location / {
        proxy_pass http://79.112.1.66:34918;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
        proxy_buffering off;
    }

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/dumontcloud.com-0001/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dumontcloud.com-0001/privkey.pem;
}

# Servidor fallback para wildcard subdomains
server {
    server_name *.dumontcloud.com;

    location / {
        proxy_pass http://127.0.0.1:8766/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }

    listen 443 ssl;
    listen [::]:443 ssl;
    ssl_certificate /etc/letsencrypt/live/dumontcloud.com-0001/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dumontcloud.com-0001/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# Redirect HTTP to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name dumontcloud.com www.dumontcloud.com *.dumontcloud.com;
    return 301 https://$host$request_uri;
}
